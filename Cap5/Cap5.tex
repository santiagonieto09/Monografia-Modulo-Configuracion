\mychapter{Capítulo 5. Arquitectura del sistema}

En el presente capítulo se explora la arquitectura del sistema, siendo este un plan en el que se definen aspectos y decisiones importantes para el software, teniendo en cuenta los requisitos del sistema, la organización y cómo se comunican los diferentes componentes entre sí.
Es importante recordar que el software contable para uso educativo en construcción consta de múltiples módulos independientes desarrollados como microservicios: Módulo de Configuración, Módulo Comercial, Módulo de Inventario (Promedio Ponderado y PEPS), Módulo de Tesorería, Módulo de Cartera, Módulos Contable Comercial y Contable Cartera, Módulos de Reportes Financieros y Módulo Educativo Contable. A pesar de que varios de estos módulos interactúan entre sí mediante APIs REST y un servidor de descubrimiento Eureka, este proyecto se enfoca específicamente en el desarrollo del módulo de Configuración, que proporciona los parámetros maestros fundamentales para el funcionamiento de todo el sistema.

Este apartado profundiza en la arquitectura del módulo de Configuración y detalla su relación con los módulos de Inventario (Promedio Ponderado y PEPS) y Cartera, los cuales presentan un avance suficiente para permitir la comunicación entre servicios. Por otro lado, la documentación técnica necesaria para que los demás microservicios en desarrollo puedan integrarse con los submódulos de Configuración se presenta detalladamente del \autoref{AnexoA} al \autoref{AnexoH}.

Para describir la arquitectura del sistema se emplea el modelo C4, que contempla cuatro diagramas principales: Contexto, Contenedores, Componentes y Código. Dado que el módulo de Configuración está compuesto por múltiples submódulos, a continuación se utiliza el submódulo de Catálogo de Cuentas como referencia para ilustrar la arquitectura C4. Los diagramas C4 de todos los submódulos se encuentran disponibles en el siguiente \href{https://drive.google.com/drive/folders/1O5IuTREhMx5zNiTa6Jo7ET5LC2ph4cPg?usp=sharing}{\underline{\textcolor{blue}{enlace}}}.

\section{Modelo C4: Descripción de la arquitectura}

\subsection{Diagrama de contexto}

El diagrama de contexto del sistema que se muestra en la \autoref{fig:Contexto} representa la vista de más alto nivel dentro del modelo C4, proporcionando una representación visual integral del sistema educativo contable ContappUC en desarrollo. Este diagrama ilustra cómo el sistema se integra en su entorno operativo, mostrando dos aspectos fundamentales:

\begin{itemize}
 \item Las personas que utilizan el sistema y sus diferentes roles
 \item Los sistemas de software externos con los que interactúa y se conecta
\end{itemize}

\begin{figure}[H]    
    \centering%
    \includegraphics[width=1.0\textwidth, height=1.0\textheight, keepaspectratio]{Cap5/Figuras/contexto.png}    
    \caption{Diagrama de contexto.}
    \label{fig:Contexto}
\end{figure}

\subsection{Diagrama de contenedores}
En la \autoref{fig:contenedor} se puede observar el diagrama de contenedores, el cual tiene como objetivo proporcionar una visión con nivel de detalle medio para comprender la organización interna del sistema y las responsabilidades de los diferentes contenedores que conforman la arquitectura del software contable educativo.

El sistema consta de seis contenedores principales: Aplicación web, API Gateway, servicio de descubrimiento, microservicios, Keycloak y base de datos. La aplicación web desarrollada en Angular 19 se comunica con los microservicios a través del API Gateway mediante un sistema REST (Representational State Transfer), de este modo el backend expone servicios web que implementan una API REST siguiendo sus principios fundamentales \cite{DominaArquitectura}:

\begin{itemize}
\item \textbf{Cliente-Servidor:} La aplicación web (cliente) y los microservicios (servidor) son independientes; la única forma de comunicación son las peticiones HTTP que fluyen a través del API Gateway.
\item \textbf{Sin estado:} Los microservicios no almacenan información de sesión; cada petición es independiente y contiene toda la información necesaria para procesarla, incluyendo el token JWT para autenticación.
\item \textbf{Identificador único:} Cada recurso del sistema (cuentas contables, terceros, productos, impuestos) se identifica mediante URIs únicas que permiten su acceso y manipulación de forma irrepetible.
\item \textbf{Uso de HTTP:} Se respetan los verbos HTTP estándar (GET para consultas, POST para creación, PUT para actualización, DELETE para eliminación) y los códigos de respuesta apropiados para cada operación. 
\end{itemize}

\begin{figure}[H]    
    \centering%
    \includegraphics[width=1.0\textwidth, height=1.0\textheight, keepaspectratio]{Cap5/Figuras/contenedor.png}    
    \caption{Diagrama de contenedores.}
    \label{fig:contenedor}
\end{figure}

\newpage

La descripción de cada contenedor y la participación del presente proyecto se encuentra en la \autoref{tab:contenedores}.

\input{Cap5/Tablas/contenedores.tex}

\subsection{Diagrama de componentes}

En la \autoref{fig:componentes} se observa el diagrama de componentes del contenedor asociado al submódulo de Catálogo de cuentas, el cual detalla los componentes y sus interacciones, proporcionando un nivel de detalle alto. Uno de los patrones arquitectónicos reflejados en este diagrama es la arquitectura limpia (o hexagonal), cuyas capas corresponden a: Domain, Application e Infrastructure.

\begin{figure}[H]    
    \centering%
    \includegraphics[width=1.0\textwidth, height=1.0\textheight, keepaspectratio]{Cap5/Figuras/componentes.png}    
    \caption{Diagrama de componentes submódulo Catálogo de Cuentas.}
    \label{fig:componentes}
\end{figure}


\section{Patrones arquitectónicos del backend}

En el módulo de Configuración se emplearon dos patrones arquitectónicos principales: la arquitectura hexagonal y la arquitectura en capas. Esta decisión responde a la evolución del proyecto bajo el enfoque PBL. Durante la Fase 1, los submódulos de Terceros, Productos, Impuestos y Catálogo de cuentas fueron desarrollados siguiendo el patrón hexagonal, por lo que se optó por mantener esta arquitectura para aprovechar el trabajo previo de los desarrolladores, quienes ya habían implementado funcionalidades importantes que posteriormente se adaptaron a los nuevos requerimientos del cliente. 

Por otro lado, los submódulos restantes (Métodos de pago, Tipos de documentos, Cuentas bancarias, Centros de costo, Centro de ayuda y Calendario contable) corresponden principalmente a funcionalidades CRUD sin lógica de negocio compleja, por lo que se implementaron utilizando arquitectura en capas, priorizando la simplicidad y la mantenibilidad. Dado que los submódulos con la misma arquitectura implementan estructuras similares, a continuación se presenta un ejemplo representativo de cada patrón: el submódulo de Catálogo de cuentas para la arquitectura hexagonal y el submódulo de Métodos de pago para la arquitectura en capas.

\subsection{Arquitectura hexagonal}

La arquitectura hexagonal, también conocida como arquitectura de puertos y adaptadores, se implementó en el submódulo de Catálogo de cuentas para gestionar la lógica de negocio compleja de las cuentas contables. Esta arquitectura facilita el desacoplamiento entre la lógica de negocio y los detalles técnicos, permitiendo mayor testabilidad y flexibilidad. Como se muestra en la \autoref{fig:patronhexagonal}, la arquitectura se organiza en tres capas principales:

\begin{enumerate}
    \item \textbf{Domain (El núcleo):} Contiene la lógica de negocio pura, modelos, enumeraciones de negocio y utilidades de dominio, independizando el núcleo de frameworks y tecnologías externas.
    
    \item \textbf{Application (Los casos de uso):} Incluye puertos de entrada y salida, además de servicios que implementan los casos de uso del sistema.
    
    \item \textbf{Infrastructure (Los adaptadores):} Alberga adaptadores de entrada (controladores REST que traducen HTTP a llamadas de dominio) y adaptadores de salida (adaptadores JPA para persistencia y adaptadores de mensajería para RabbitMQ), junto con la configuración de frameworks.
\end{enumerate}


\begin{figure}[H]    
    \centering%
    \includegraphics[width=0.8\textwidth, height=0.8\textheight, keepaspectratio]{Cap5/Figuras/patronhexagonal.png}    
    \caption{Capas de la arquitectura hexagonal en Catálogo de cuentas.}
    \label{fig:patronhexagonal}
\end{figure}

Para ilustrar mejor cómo funciona la arquitectura hexagonal en la práctica, a continuación se describe el flujo de una operación típica, como la búsqueda de cuentas contables.

\subsubsection{Flujo de operación}

En la \autoref{fig:patronhexagonalflow} se muestra el flujo completo de una operación de búsqueda de cuentas contables. El diagrama ilustra cómo la petición del cliente atraviesa las tres capas de la arquitectura hexagonal: desde la capa de Infraestructura (\texttt{AccountCatalogueController}) que recibe la petición HTTP, pasando por la capa de Aplicación (\texttt{AccountCatalogueSearchService}) que orquesta la lógica de negocio utilizando el Dominio (\texttt{AccountCatalogue}), hasta la persistencia mediante el adaptador JPA y finalmente el retorno de la respuesta al cliente.

\begin{figure}[H]    
    \centering%
    \includegraphics[width=1.0\textwidth, height=0.3\textheight]{Cap5/Figuras/flujohexagonal.png}    
    \caption{Operación de búsqueda de cuentas contables.}
    \label{fig:patronhexagonalflow}
\end{figure}


\subsection{Arquitectura en capas}

La arquitectura en capas se aplicó en el submódulo de Métodos de pago, facilitando el desarrollo rápido y la mantenibilidad en módulos con funcionalidades simples. A diferencia de la arquitectura hexagonal que se organiza por capacidades, esta arquitectura separa responsabilidades por capas técnicas. Como se ilustra en la \autoref{fig:patroncapas}, las capas específicas son las siguientes:

\begin{enumerate}
    \item \textbf{Presentation (Capa de API):} Expone endpoints REST, valida entrada HTTP, transforma DTOs a modelos de dominio y retorna respuestas HTTP.
    
    \item \textbf{Domain (Capa de Lógica de Negocio):} Contiene la lógica de negocio pura, reglas de validación, orquestación de operaciones y manejo de eventos de negocio. Los servicios de mensajería están integrados en esta capa y las interfaces de servicio definen los contratos.
    
    \item \textbf{DataAccess (Capa de Persistencia):} Maneja la persistencia en base de datos, consultas, transacciones y mapeo bidireccional entre entidades y modelos de dominio.
\end{enumerate}


\begin{figure}[H]    
    \centering%
    \includegraphics[width=0.8\textwidth, height=0.8\textheight, keepaspectratio]{Cap5/Figuras/patroncapas.png}    
    \caption{Estructura de la arquitectura en capas de Métodos de Pago.}
    \label{fig:patroncapas}
\end{figure}

De manera similar, para ilustrar el funcionamiento de la arquitectura en capas, se presenta a continuación el flujo de una operación de búsqueda en el submódulo de Métodos de Pago.

\subsubsection{Flujo de operación}

En la \autoref{fig:patroncapasflow} se presenta el flujo de una operación de búsqueda de métodos de pago. El diagrama muestra cómo la petición del cliente atraviesa secuencialmente las tres capas: desde la capa de Presentation (\texttt{PaymentMethodController}) que recibe la petición HTTP, pasando por la capa de Domain (\texttt{PaymentMethodServiceImpl}) que ejecuta la lógica de negocio, hasta la capa de DataAccess que gestiona la persistencia con el repositorio JPA y finalmente el retorno de la respuesta al cliente.

\begin{figure}[H]    
    \centering%
    \includegraphics[width=1.0\textwidth, height=0.35\textheight]{Cap5/Figuras/flujocapas.png}    
    \caption{Operación de búsqueda de métodos de pago.}
    \label{fig:patroncapasflow}
\end{figure}
