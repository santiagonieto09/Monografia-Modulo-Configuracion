\mychapter{Capítulo 5. Arquitectura del sistema}

En el presente capítulo se explora la arquitectura del sistema, siendo este un plan en el que se definen aspectos y decisiones importantes para el software, teniendo en cuenta los requisitos del sistema, la organización y cómo se comunican los diferentes componentes entre sí.
Es importante recordar que el software contable para uso educativo en construcción consta de múltiples módulos independientes desarrollados como microservicios: Módulo de Configuración, Módulo Comercial, Módulo de Inventario (Promedio Ponderado y PEPS), Módulo de Tesorería, Módulo de Cartera, Módulos Contable-Comercial y Contable-Cartera, Módulos de Reportes Financieros, y Módulo Educativo Contable. A pesar de que varios de estos módulos interactúan entre sí mediante APIs REST y un servidor de descubrimiento Eureka, este proyecto se enfoca específicamente en el desarrollo del módulo de configuración, que proporciona los parámetros maestros fundamentales para el funcionamiento de todo el sistema.

La descripción de la arquitectura hará énfasis en este módulo y ofrecerá una descripción general de cómo se relaciona con los módulos de Inventario (Promedio Ponderado y PEPS) y Cartera, los cuales hasta la fecha han tenido avances significativos en su desarrollo, lo que permitió la comunicación con el módulo de configuración. En el anexo B se especifica un documento técnico que detalla una guía para que los demás microservicios que componen el sistema y que están en fase inicial de construcción puedan comunicarse con el módulo de configuración. 

Para describir la arquitectura del sistema se emplea el modelo C4, que contempla cuatro diagramas principales: Contexto, Contenedores, Componentes y Código. A continuación se presenta la arquitectura del catálogo de cuentas, los diagramas C4 de los demás módulos no se incluyen aquí, evitando la sobrecarga visual de este documento, para ello puede dirigirse al siguiente \href{https://drive.google.com/drive/folders/1O5IuTREhMx5zNiTa6Jo7ET5LC2ph4cPg?usp=sharing}{\underline{\textcolor{blue}{enlace}}}, donde encontrará todos los diagramas correspondientes a cada módulo desarrollado.

\section{Modelo C4: Descripción de la arquitectura}

\subsection{Contexto}

El diagrama de contexto del sistema que se muestra en la Figura \ref{fig:Contexto} representa la vista de más alto nivel dentro del modelo C4, proporcionando una representación visual integral del sistema educativo contable CONTAPP en desarrollo. Este diagrama ilustra cómo el sistema se integra en su entorno operativo, mostrando dos aspectos fundamentales:

\begin{itemize}
 \item Las personas que utilizan el sistema y sus diferentes roles
 \item Los sistemas de software externos con los que interactúa y se conecta
\end{itemize}

 Debido a que algunos diagramas son demasiado grandes para su correcta lectura, todos los diagramas del C4 se encuentra disponibles en el siguiente enlace.

\begin{figure}[h!]    
    \centering%
    \includegraphics[width=1.0\textwidth, height=1.0\textheight, keepaspectratio]{Cap5/Figuras/contexto.png}    
    \caption{Diagrama de contexto.}
    \label{fig:Contexto}
\end{figure}

\newpage
\subsection{Contenedores}

En la figura \ref{fig:contenedor} se puede observar el diagrama de contenedores, el cual tiene como objetivo proporcionar una visión con nivel de detalle medio para comprender la organización interna del sistema y las responsabilidades de los diferentes contenedores que conforman la arquitectura del software contable educativo.

El sistema consta de seis contenedores principales: aplicación web, API Gateway, servicio de descubrimiento, microservicios, Keycloak y base de datos. La aplicación web desarrollada en Angular 19 se comunica con los microservicios a través del API Gateway mediante un sistema REST (Representational State Transfer), de este modo el backend expone servicios web que implementan una API REST siguiendo sus principios fundamentales \cite{DominaArquitectura}:

\begin{itemize}
\item \textbf{Cliente-Servidor:} La aplicación web (cliente) y los microservicios (servidor) son independientes; la única forma de comunicación son las peticiones HTTP que fluyen a través del API Gateway.
\item \textbf{Sin estado:} Los microservicios no almacenan información de sesión; cada petición es independiente y contiene toda la información necesaria para procesarla, incluyendo el token JWT para autenticación.
\item \textbf{Identificador único:} Cada recurso del sistema (cuentas contables, terceros, productos, impuestos) se identifica mediante URIs únicas que permiten su acceso y manipulación de forma irrepetible.
\item \textbf{Uso de HTTP:} Se respetan los verbos HTTP estándar (GET para consultas, POST para creación, PUT para actualización, DELETE para eliminación) y los códigos de respuesta apropiados para cada operación. 
\end{itemize}

\begin{figure}[h!]    
    \centering%
    \includegraphics[width=1.0\textwidth, height=1.0\textheight, keepaspectratio]{Cap5/Figuras/contenedor.png}    
    \caption{Diagrama de contenedores.}
    \label{fig:contenedor}
\end{figure}

\newpage

La descripción de cada componente y la participación del presente proyecto se encuentra en la tabla \ref{tab:contenedores}.

\input{Cap5/Tablas/contenedores.tex}


\newpage
\subsection{Componentes}

En la figura \ref{fig:componentes} se puede observar el diagrama de componentes del contenedor asociado al módulo de catálogo de cuentas, este tiene como objetivo detallar los componentes y cómo estos interactúan, proporcionando un nivel de detalle alto. Uno de los patrones arquitectónicos que se pueden ver reflejados en este diagrama, es el patrón de arquitectura limpia (o hexagonal), para practicidad en la lectura del presente diagrama se ha dividido en secciones que corresponden a las capas mencionadas: Domain, Application, Infraestructure.

\begin{figure}[h!]    
    \centering%
    \includegraphics[width=1.0\textwidth, height=1.0\textheight, keepaspectratio]{Cap5/Figuras/componentes.png}    
    \caption{Diagrama de componentes.}
    \label{fig:componentes}
\end{figure}


\section{Patrón arquitectónico}

En el módulo de configuración se emplean dos patrones arquitectónicos principales: la arquitectura hexagonal y la arquitectura en capas. Esta decisión responde a la evolución del proyecto bajo el enfoque de Aprendizaje Basado en Proyectos (PBL). Durante la fase 1, los módulos de terceros, productos, impuestos y catálogo fueron desarrollados siguiendo el patrón hexagonal, por lo que se optó por mantener esta arquitectura para aprovechar el trabajo previo de los desarrolladores, quienes ya habían implementado funcionalidades importantes que posteriormente se adaptaron para satisfacer los nuevos requerimientos del cliente. Por otro lado, los módulos restantes como métodos de pago, tipos de documentos, bancos, cuentas bancarias, centros de costo, centro de ayuda y calendario contable corresponden principalmente a funcionalidades CRUD sin lógica de negocio compleja, por lo que se implementaron utilizando el patrón de arquitectura en capas, priorizando la simplicidad y la mantenibilidad. A continuación se describen de manera conceptual y gráfica los patrones arquitectónicos implementados.


\subsection{Arquitectura hexagonal}
La arquitectura hexagonal, también conocida como arquitectura de puertos y adaptadores, es un patrón diseñado para crear componentes de aplicación débilmente acoplados, facilitando la conexión con el entorno externo. Su objetivo principal es aislar la lógica de negocio del núcleo de la aplicación de factores externos como bases de datos, interfaces de usuario o sistemas de mensajería, lo que mejora la modularidad, mantenibilidad y testabilidad. El sistema se divide en componentes intercambiables conectados a través de puertos (interfaces que representan puntos de entrada y salida) e implementados por adaptadores, que traducen las interacciones entre el mundo exterior y el núcleo \cite{HexagonalArchitecture}.

Como se ilustra en la Figura \ref{fig:hexagonal}, la arquitectura se organiza en capas concéntricas: el núcleo del dominio contiene entidades y lógica de negocio; la capa de aplicación incluye servicios que orquestan casos de uso; y la capa de infraestructura alberga adaptadores. Estos se clasifican en primarios (como controladores REST o interfaces gráficas, que inician la comunicación) y secundarios (como repositorios de bases de datos o servicios de mensajería, que responden a la aplicación). En el proyecto, los adaptadores primarios incluyen la API REST y la interfaz de línea de comandos, mientras que los secundarios comprenden PostgreSQL para persistencia y RabbitMQ para comunicación asíncrona entre microservicios.


\begin{figure}[h!]    
    \centering%
    \includegraphics[width=0.9\textwidth, height=0.8\textheight, keepaspectratio]{Cap5/Figuras/hexagonal.png}    
    \caption{Arquitectura general con patrón hexagonal.}
    \label{fig:hexagonal}
\end{figure}

 Esta separación garantiza que la lógica de negocio permanezca independiente de los detalles de implementación tecnológicos, permitiendo reemplazar cualquier adaptador sin afectar el núcleo del dominio. El principio de inversión de control se aplica a nivel arquitectónico, donde las dependencias se dirigen hacia el centro del sistema, haciendo que la lógica de negocio solo dependa de los puertos (interfaces) diseñados para satisfacer sus necesidades y no de herramientas o adaptadores específicos.
 
\subsection{Arquitectura en capas}

La arquitectura por capas es una de las más empleadas, debido a su sencillez y al hecho de que se adopta automáticamente cuando no se tiene certeza sobre qué patrón arquitectónico elegir para el desarrollo de la aplicación. Este enfoque implica segmentar la aplicación en diferentes niveles, con el propósito de asignar a cada uno una función específica, tales como una capa de interfaz de usuario (UI), una capa de lógica de negocio (servicios) y una capa de acceso a datos (DAO). No obstante, este patrón no establece un número fijo de capas para la aplicación, sino que enfatiza la división de la aplicación en niveles (aplicando el principio de Separación de Responsabilidades (SoC)) \cite{ArquitecturaCapas}.

En la implementación práctica, generalmente se utiliza un esquema de 4 capas: presentación, negocio, persistencia y base de datos. Sin embargo, es común observar que las capas de negocio y persistencia se fusionan en una sola, especialmente cuando la lógica de almacenamiento se integra directamente en la capa de negocio \cite{ArquitecturaCapas}. 

En la Figura \ref{fig:capas} se observa la arquitectura organizada en cuatro capas horizontales que representan la separación de responsabilidades.

\begin{figure}[h!]    
    \centering%
    \includegraphics[width=1.0\textwidth, height=1.0\textheight, keepaspectratio]{Cap5/Figuras/capas.png}    
    \caption{Arquitectura general con patrón en capas.}
    \label{fig:capas}
\end{figure}